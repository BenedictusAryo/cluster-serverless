# Default values for cluster-serverless-infra
# Infrastructure ArgoCD Applications for GitOps-powered serverless platform
# Optimized for VPS/Homelab deployments

# Global configuration
global:
  clusterName: cluster-serverless
  domain: benedict-aryo.com
  environment: production

# Cilium CNI configuration
# eBPF-based networking and security  
# Managed by cluster-init (not cluster-serverless-infra)
cilium:
  enabled: false  # Managed separately by cluster-init
  version: "1.18.4"
  
  # Gateway API for ingress routing
  gatewayAPI:
    enabled: true
  
  # Replace kube-proxy with eBPF (set to false for compatibility)
  kubeProxyReplacement: false
  
  # Hubble observability
  hubble:
    enabled: true
    relay:
      enabled: true
    ui:
      enabled: false  # Disable UI for resource savings

# Sealed Secrets Controller
# Encrypt secrets for Git storage
sealedSecrets:
  enabled: true
  version: "v0.33.1"

# Knative Serving configuration
# Serverless request-driven workloads
# Managed via Knative Operator CRs
knativeServing:
  enabled: true
  version: "1.18.0"
  
  # Kourier ingress (enabled via operator)
  ingress:
    kourier:
      enabled: true

# Knative Eventing configuration  
# Event-driven architecture
# Managed via Knative Operator CRs
knativeEventing:
  enabled: true
  version: "1.18.0"

# ArgoCD Ingress Configuration
# Provides external access to ArgoCD UI via Cloudflare Tunnel + Kourier
argocd:
  ingress:
    enabled: true
    hostname: argocd.benedict-aryo.com
    # Traffic: Cloudflare → Tunnel → Kourier → ArgoCD Server (HTTPS)

# OpenTelemetry configuration
# Metrics and trace collection
opentelemetry:
  enabled: true
  namespace: observability
  
  collector:
    mode: deployment
    replicas: 1
    
    # Collector configuration
    config:
      receivers:
        otlp:
          protocols:
            grpc:
              endpoint: 0.0.0.0:4317
            http:
              endpoint: 0.0.0.0:4318
      
      processors:
        batch:
          timeout: 10s
          send_batch_size: 1024
      
      exporters:
        jaeger:
          endpoint: jaeger-collector.observability.svc.cluster.local:14250
          tls:
            insecure: true
        
        prometheus:
          endpoint: 0.0.0.0:8889
      
      service:
        pipelines:
          traces:
            receivers: [otlp]
            processors: [batch]
            exporters: [jaeger]
          metrics:
            receivers: [otlp]
            processors: [batch]
            exporters: [prometheus]
    
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

# Jaeger configuration
# Distributed tracing UI
jaeger:
  enabled: true
  namespace: observability
  strategy: allInOne  # Simple deployment for VPS/homelab
  
  # Ingress for external access
  ingress:
    enabled: true
    hostname: jaeger.benedict-aryo.com
    # Traffic: Cloudflare → Tunnel → Kourier → Jaeger Query (HTTP)
  
  # Storage configuration
  storage:
    type: memory
    options:
      memory:
        maxTraces: 100000
  
  # UI access
  ui:
    enabled: true
    service:
      type: ClusterIP
  
  # Resource limits
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 1024Mi

# Cloudflare Tunnel configuration
# Secure external access without exposed ports
cloudflareTunnel:
  enabled: true  # Enabled - sealed secret in templates/cloudflare-tunnel/secret.yaml
  namespace: cloudflare-tunnel
  
  # Deployment mode:
  # - false (default): Token-based - simple but requires manual dashboard config for routes
  # - true: Config-based - GitOps managed routes but requires tunnel ID and credentials.json
  useConfigFile: false
  
  # Tunnel ID (required only for config-based mode)
  # Get from: Cloudflare dashboard → Tunnels → (your tunnel) → Overview → Tunnel ID
  tunnelId: "3c2073fd-74ef-4c5d-9c9d-22d0068be234"
  
  # Replica count for HA
  replicas: 2
  
  # Credentials (SealedSecret deployed via GitOps)
  # Token-based mode: Only needs tunnel-token in secret
  # Config-based mode: Needs credentials.json in secret
  credentials:
    useExistingSecret: false  # SealedSecret is managed in templates/
    secretName: cloudflare-tunnel-secret
  
  # Ingress Rules
  # ============
  # With single wildcard route approach (RECOMMENDED):
  #   Configure in Cloudflare: *.benedict-aryo.com → kourier-gateway
  #   Then manage ALL routing via Kubernetes Ingress/Knative in Git
  #   These values below are NOT USED - kept for reference only
  #
  # Token-based mode (useConfigFile: false):
  #   Configure single wildcard in Cloudflare dashboard manually
  #
  # Config-based mode (useConfigFile: true):
  #   These are applied automatically but NOT RECOMMENDED
  #   Use Kubernetes Ingress instead for better GitOps control
  ingress:
    # Wildcard for all Knative Services
    - hostname: "*.benedict-aryo.com"
      service: http://kourier-gateway.kourier-system.svc.cluster.local:80
    
    # ArgoCD UI access
    - hostname: argocd.benedict-aryo.com
      service: https://argocd-server.argocd.svc.cluster.local:443
      originRequest:
        noTLSVerify: true  # Required for self-signed certs
    
    # Jaeger tracing UI access
    - hostname: jaeger.benedict-aryo.com
      service: http://jaeger-query.observability.svc.cluster.local:16686
  
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi
