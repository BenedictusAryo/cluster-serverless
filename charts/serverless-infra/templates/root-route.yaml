{{- if .Values.rootRoute.enabled }}
---
apiVersion: serving.knative.dev/v1beta1
kind: DomainMapping
metadata:
  name: benedict-aryo.com
  namespace: default
  annotations:
    argocd.argoproj.io/sync-wave: "5"
    # Track this resource in the cluster-serverless chart
    argocd.argoproj.io/tracking-id: cluster-serverless:serving.knative.dev/DomainMapping:default/benedict-aryo.com
spec:
  ref:
    name: {{ .Values.rootRoute.primaryService | default "root-redirect" }}
    kind: Service
    apiVersion: serving.knative.dev/v1
    namespace: default
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: root-domain-route
  namespace: {{ .Values.rootRoute.namespace | default "default" }}
  annotations:
    argocd.argoproj.io/sync-wave: "4"
    # Track this resource in the cluster-serverless chart
    argocd.argoproj.io/tracking-id: cluster-serverless:gateway.networking.k8s.io/HTTPRoute:{{ .Values.rootRoute.namespace | default "default" }}/root-domain-route
spec:
  parentRefs:
  - name: cloudflare-gateway
    namespace: gateway-system
  hostnames:
  - benedict-aryo.com  # Root domain
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: kourier
      port: 80
      namespace: knative-serving  # Route through Kourier like wildcard route
---
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: root-domain-reference-grant
  namespace: knative-serving
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    # Track this resource in the cluster-serverless chart
    argocd.argoproj.io/tracking-id: cluster-serverless:gateway.networking.k8s.io/ReferenceGrant:knative-serving/root-domain-reference-grant
spec:
  from:
  - group: gateway.networking.k8s.io
    kind: HTTPRoute
    namespace: {{ .Values.rootRoute.namespace | default "default" }}
  to:
  - group: ""
    kind: Service
    name: kourier
{{- end }}