# Default values for serverless-infra subchart
# Infrastructure components: Knative, Kourier, Jaeger, OpenTelemetry, etc.

# Global configuration (inherited from parent)
global:
  clusterName: cluster-serverless
  domain: benedict-aryo.com
  environment: production

# Cilium CNI configuration
# eBPF-based networking and security
# NOTE: Cilium is installed directly via setup-argocd.sh, not via Helm
cilium:
  enabled: false
  version: "1.18.4"

  # Gateway API for ingress routing
  gatewayAPI:
    enabled: true

  # Disable standalone Envoy proxy (Gateway API uses its own)
  l7Proxy: false
  envoy:
    enabled: false

  # IPAM configuration
  ipam:
    mode: kubernetes

  # Replace kube-proxy with eBPF
  kubeProxyReplacement: strict

  # Hubble observability
  hubble:
    enabled: true
    relay:
      enabled: true
    ui:
      enabled: true

  # Resources for Cilium agents
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 1000m
      memory: 512Mi

# Sealed Secrets Controller
# Encrypt secrets for Git storage
sealedSecrets:
  enabled: true
  version: "v0.33.1"

# Knative Serving configuration
# Serverless request-driven workloads
knativeServing:
  enabled: true
  version: "1.18.0"  # Compatible with Knative Operator v1.18.0
  namespace: knative-serving

  # Domain configuration
  domain: benedict-aryo.com

  # Ingress class (Kourier)
  ingressClass: kourier.ingress.networking.knative.dev

  # Autoscaling defaults
  autoscaling:
    minScale: 0  # Scale to zero
    maxScale: 10  # Max replicas per service
    scaleDownDelay: 30s
    targetBurstCapacity: 200

  # Resource defaults for Knative services
  containerDefaults:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 1000m
      memory: 512Mi

# Knative Eventing configuration
# Event-driven architecture
knativeEventing:
  enabled: true
  version: "1.18.0"  # Compatible with Knative Operator v1.18.0
  namespace: knative-eventing

  # Default broker configuration
  broker:
    type: MTChannelBasedBroker
    deliveryRetryAttempts: 3

  # Default channel type
  channel:
    type: InMemoryChannel

# Kourier Ingress configuration
# Lightweight alternative to Istio
kourier:
  enabled: true
  version: "1.18.0"  # Compatible with Knative Serving v1.18.0
  namespace: kourier-system

  # Service configuration
  service:
    type: ClusterIP  # Internal only, exposed via Cloudflare Tunnel
    annotations: {}

  # Gateway resources
  gateway:
    replicas: 2  # HA setup
    resources:
      requests:
        cpu: 100m
        memory: 64Mi
      limits:
        cpu: 500m
        memory: 128Mi

# OpenTelemetry configuration
# Metrics and trace collection
opentelemetry:
  enabled: true
  namespace: observability

  collector:
    mode: deployment
    replicas: 1

    # Collector configuration
    config:
      receivers:
        otlp:
          protocols:
            grpc:
              endpoint: 0.0.0.0:4317
            http:
              endpoint: 0.0.0.0:4318

      processors:
        batch:
          timeout: 10s
          send_batch_size: 1024

      exporters:
        jaeger:
          endpoint: jaeger-collector.observability.svc.cluster.local:14250
          tls:
            insecure: true

        prometheus:
          endpoint: 0.0.0.0:8889

      service:
        pipelines:
          traces:
            receivers: [otlp]
            processors: [batch]
            exporters: [jaeger]
          metrics:
            receivers: [otlp]
            processors: [batch]
            exporters: [prometheus]

    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

# Jaeger configuration
# Distributed tracing UI
jaeger:
  enabled: true
  namespace: observability
  strategy: allInOne  # Simple deployment for VPS/homelab

  # Ingress for external access
  ingress:
    enabled: true
    hostname: jaeger.benedict-aryo.com

  # Storage configuration
  storage:
    type: memory
    options:
      memory:
        maxTraces: 100000

  # UI access
  ui:
    enabled: true
    service:
      type: ClusterIP

  # Resource limits
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 1024Mi

# Cloudflare Tunnel configuration
# Secure external access without exposed ports
cloudflareTunnel:
  enabled: false  # Moved to k0s-cluster-bootstrap/cluster-init

# ArgoCD Ingress Configuration
# Provides external access to ArgoCD UI via Cloudflare Tunnel + Kourier
argocd:
  ingress:
    enabled: false  # Moved to k0s-cluster-bootstrap/cluster-init

# Root Domain Route Configuration
# Configure a primary service to respond to the root domain (benedict-aryo.com)
rootRoute:
  enabled: false  # Set to true to enable root domain routing
  namespace: default  # Namespace where to create the HTTPRoute resource
  primaryService: hello-world  # Name of the primary service to route to
  serviceNamespace: default  # Namespace of the primary service
