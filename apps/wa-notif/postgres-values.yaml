---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: wa-notif-postgres-credentials
  namespace: apps
spec:
  encryptedData:
    database: AgAlLjhcSNj6auwj0VJ2UAlxvJLlX5ogk2In85XsC1N2s34IbZllAqGasoxAKNvKi2PzN15WepFi9ytxxWEcxKy9e3uJOwJEuXEWt8nH0+U/B8hThiyZLVMn0LM8q3mj0hlbru9XlGfA2CBa1VFAo7INZG+ZAJRWgv/9yBqWGrcv2TL+/cPr8+tOjC7ID/sWXYXnDJjd1pvO1ymPkl6gg/+/GM39Ct5p/cfVbdbHymVb49GpfHOhbv7OeEqoiViSUNqL513qF0ESKE3+9/g5a25L1ukb9ZwyzdV8rPuq9Js4aaO58UoUhXv/y7L5P1aa6JOdcr2WNCxJ+d1zNRvOdMJTr/kcRgmAFsw5n9XW2MIbYE39747SsygzzKIiQWITbTGBi8MyPBEnrNJ9a56hNccefQ423RSlyROl/wqDUUnXnqatKla3E+7p+IbR7guWyAyD7Wca4tOLB6v+AfV0XXqWgAyafvL+69pWDvKYrAiAZ7epx1LNC7rIgr5LyY4/Qpsy0tv/GdRCI9/ct2U+KG/iNtA0PaJ+UyD2UkadZAIG+aNAkaGZO2QtVSarAq79Og0vv2ulCljYnvWZF/rHKVkQ6NWZPDaAxSmeZyinN082Bmu9wdcEm1bltCJO7orUGAdgxNZfjqQPnlPviVnHAlzKONnBfapzrVbO93JXqAtjH/oabTyUdwYjKvC41yFS6ipdgM+LuJb1REc=
    password: AgBZhMnmq1fJal1W8qRLWjAcFDDZ48Z5NpY2Oxo4TS2bWtiDRipRXWMz8liAKICpCMcMOsacryzP489eR+SC0kVKqe1cOO/BaHX4IEKfxSZr6wJ2VycnDrxu2IXZXUU7talZlijB6rMYSuhi9snxnAsFTX9By42CwXWdsbmpSuJQaU6STG3sy7s4xg7J1CriedKMKgdFJ+kZyE/E60RPFIvwbm4crQHKqCltZYuVboSbn4qAFkohPIFrC1kcm8mheWgrcTfdTq2WsJBALL+ya6VTfHW+NXV2Q7wZ81ly64nCTr0+X9CaRbjsLL1d5K41XleLGf0G2bM6aBFT4vAyd9e0+bsayWVAUfIjO91otigvTFNkn0mFYbH4BXCIu+ERiMarooEuz5EBd4sSXQ93GOzpvdAuo+ARnUzgrAYDhGIj3AoxOtlHDoIu2aq/GZQ339mlaCAsCJtiFOG3I8+AKdU/dGw68x7WzyeWpN6MGeR59MGzFfzypkWlcLEvIwfULdBb22YCVEvcYs9tGX6EoGkKhQawgoQ/Srw902/YNIR4NeqbG2Yjl/ijtJ5V3X44PAUPvP3okE51ujZmaCTzvLPjLJ2RkE9mKvgx862AZa3e5yNBWAZRU2/umo+dWh65GFuqg8SDEJQEIqQbNZKTDnRtyR9qflQUEchn/dWfo+kviBGtlirna3SbuWitwlt0pUmJz4MwQr1oD3Vivj40sPlxXyM=
    username: AgAU5Fo6WJW+XVDx8cSD1GDtnDTdK47uoJ+ItiEymWnXW7Nt6/XvimhjPzRjJS2CetYIwtPq4MlE+3ICDhSnh+pKyaCd7D2BeiyBdPmGSUsSio2HLG5OBgsICF1mUpfy4T+lHeAj3bW0av96KnNaLUBGW7jl1xtU32KsGq6JYfdTKRaryoPdqd/Arrbi1+wQYVz0H62gLIsAw8KVgoMhKa1ZUzZwfaJ+KoNyGiXW99X2kC67K/Azp5Hw5Jz0aW1dmfxKy4YpgfVdMHycSQoTqqeX3+08sF39og+MscFBRmJCwKJA+spYE7jrrRjbmSiwKu5rYTJoTPGpg9SmatQSpirrkXFjj65EgTl+wLO6tJkr30zm++dnkdkEv9DskVpnbjV7JFuxg8wFCnwvocfb99s62zxhKvFMbUHuwkALAv6Ow2y26htvBaNsKQR9UNAIG0yV2GO2yFscNgcKNUsI3ogW6qMM5U+fewN+jQwFe5JAbcZ9hDR0kohGGVIUvLiFurJLg+qFxkR8OaY/CACDECATa3AKH1XrqXmaWE2ThzZvpzkFsHLqWfmyU7pBoAcAdRpqbGQVKbDc9m8fb3xkbPnY37ZWXCAudHzNUMoDDLBjdMGn39FSlU7Ddq4hbfNLwew+aMPunYguHLfS7OW1VgTZLxbXOiGRkQc38zXO01vn34VGNyCf8m05lt/419VSGqSTiupl1NTbVfY=
    database-uri: AgCELWQV/Jzr6SWrhuDqd9ehRqw1EsKu2JtmfSvCuCNV9wnrHRFuYPr4ZGDw6yB1BjpvBCZVYtZSVORFSSllC82IsxPtqoQHi/tVRRgHtuakXV0fGVgh5ErBjS389zzxrCKMoz46iUEbJOwDQAV4SdiXiSj1cUByOp4Glli7Dm0IV3D80ZbcR8b+4mp2H4/YlLpXRx1RJr25MRu1bQjcm8vjOBTxwoIIBZiksumBIj01LkE+FVtO6nSe6JGRTSLpwPESeibOpn9JftdwTlAZAHoIg+DP0/dU6QamdyKI/RI3E/ujMFIffbyyw0tdc8SGmPJwhJTjGfKri58RJO6t+BKThtLXhfOujVlWHiL5Gb0iP9PShYZIV1hMEUQb+rlCONx8p2lnKXnk+ULizt06hZ96IOCVad3xgzdeecoq5JlcSjoMGLQ0demv4kr/mh/xR1c0AzRgAzaq8XGfoDrbG4YpIE1BI4e74tc6jfnkPNI03cMde8SGtXBgJAkPYUz7vofR7t81rZbAXZzPgBAso1AeH/RwAO45eNkwT4DfP5NuP9AS/KxyUFUxaJo7AcpwR7Yse69WDegb/a5cU4L4YXogtXwF2Dms8hEWsGDdJHIbmtAz1SsUWikAbHCbRHls8iIhYoWNi0F5QAaoXJuqha/k/HdlwCc6y+NawltttAnsA5m5ZSCNPf70FV9E4SbQFaDZjsOqod6yu06BFgrG+eyUea+hQU76xK4Baab6rDBFTmzBpiPiaVww2hjCl+H+UOSGQE1bUANtsBFwwrAVBiTqE08KSg20RQ==
  template:
    metadata:
      name: wa-notif-postgres-credentials
      namespace: apps
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: wa-notif-postgres-admin
  namespace: apps
spec:
  encryptedData:
    postgres-password: AgBsxYP16j6xuT1TkGoKKLrqGNv8n76eTko/nPW76Gb8gTWUAPPDmdR40hMzHc81zBJww5F2N42UfrEWAIDSBkSyw5hOkWmfgdDTqbRDtt/kpLvg2apIFu4rnqb0EdmBCv7seE0Q4/un3RJ7VtQUBlsYSBCykH/nEw/wKEehiKwOLhoRNyNerDAinIeEP83mM9pPhKY2BfGmu1BgXw7cQaGEV/pAJYNL9gvS1lAetJm2EGcatlB0X3E8IZFVco8EYzYaGlabDjKcpuiINFUk74MjVmwgp3AQ8r+6WuVbBMSMW167WiPmgVZxoQXpwefBBzPXk4E/606SJ3LEEQcIQgSQDBBgt2K6kAP3IF/05tmpGMJyBiRegAc4pXpONGb1GrgaOYb2RWYGOwo4UHmz/H7wytymq0W/SownhqkNwZdETukUsvLy6I6v54cJ5Uy+5Btsuq0W4TMsgASyJbtEF7lzuZHWRWjDAMSGPVovzKA/+ZxOz9Qjl0MK7vuwat64wRx0/7UNKqWGPq+h0gPALIJODKUxV5bjHAqkDrSc8I2eI4m04vonbq8bHBTkP/QxZ6/JIrD192VxMj9CurjBhDgt48YuFtBbK9EAabzJ50aJ3bWZ/8RJDwoHT2uMHujVVAkT9m/2ZVI0NKaCkoTz8SIw/qMFMq8FOSXj7LYJFuaZlf+mAUZ8xqcpwQ1jE2Vt90awWWz49/onPcktVw==
  template:
    metadata:
      name: wa-notif-postgres-admin
      namespace: apps
---
apiVersion: batch/v1
kind: Job
metadata:
  name: wa-notif-db-provision
  namespace: apps
spec:
  template:
    spec:
      containers:
        - name: psql
          image: bitnamilegacy/postgresql:17
          env:
            - name: PGHOST
              value: postgres.infra.svc.cluster.local
            - name: PGPORT
              value: "5432"
            - name: PGUSER
              value: postgres
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: wa-notif-postgres-admin
                  key: postgres-password
            - name: APP_DB
              valueFrom:
                secretKeyRef:
                  name: wa-notif-postgres-credentials
                  key: database
            - name: APP_USER
              valueFrom:
                secretKeyRef:
                  name: wa-notif-postgres-credentials
                  key: username
            - name: APP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: wa-notif-postgres-credentials
                  key: password
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail
              until pg_isready -h "$PGHOST" -p "$PGPORT" -U "$PGUSER"; do
                sleep 2
              done
              psql -v ON_ERROR_STOP=1 <<PSQL_EOF
              SELECT format('CREATE DATABASE %I;', '$APP_DB')
              WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname='$APP_DB')
              \gexec
              DO \$body\$
              BEGIN
                IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname='$APP_USER') THEN
                  EXECUTE format('CREATE USER %I WITH PASSWORD %L', '$APP_USER', '$APP_PASSWORD');
                ELSE
                  EXECUTE format('ALTER USER %I WITH PASSWORD %L', '$APP_USER', '$APP_PASSWORD');
                END IF;
              END
              \$body\$;
              SELECT format('ALTER DATABASE %I OWNER TO %I;', '$APP_DB', '$APP_USER')
              WHERE EXISTS (SELECT FROM pg_roles WHERE rolname='$APP_USER')
              \gexec
              PSQL_EOF
      restartPolicy: OnFailure
