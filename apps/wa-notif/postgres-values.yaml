---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: wa-notif-postgres-credentials
  namespace: apps
spec:
  encryptedData:
    # PLACEHOLDER - Replace with actual sealed secrets generated using kubeseal
    # Generate using: kubeseal --controller-namespace kube-system --controller-name sealed-secrets-controller --format yaml < secret.yaml
    database: REPLACE_WITH_SEALED_DATABASE_NAME
    password: REPLACE_WITH_SEALED_PASSWORD
    username: REPLACE_WITH_SEALED_USERNAME
    database-uri: REPLACE_WITH_SEALED_DATABASE_URI
  template:
    metadata:
      name: wa-notif-postgres-credentials
      namespace: apps
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: wa-notif-postgres-admin
  namespace: apps
spec:
  encryptedData:
    # Using the same encrypted password as blog app for consistency
    # This should match the postgres-admin secret in infra namespace
    postgres-password: AgBWkVsXvAAq/Aad4i7m9LboLYJWgE5Hnu0Y0vyIGTKS86i5+oRP4r8JBLzzT0cFHVK7QO/9QwCaPgrbrEW/zo6pbRP3IX0BARMDZRWnvy9ifK2u1QwJ+4qCR4kU+u/wgQdBIL+JLBas/8WlYNR1osE9HazkmPaXuLPBpBddbOmnZCGLqcNMdLEYfnqOUGvaAa2/hPh2ImLJ5aN/HHxPs2rSAfJ4gWaaa6jbsy5ggaMKt5rCSyEENXMTJsxD7BNsfNnP0LPw7MR/SOUzp2pB07znBzQj8BiF2jbbIzfNpR4QpBTbktWMzwHb1Yt5jAL4F/8ravKw5cRjdZbitQn1nmMobJRns5GCIYCzJe2O+NEQQIwwvbz5Jv/CfeTZ8MhVeTIiUr5LKGmAG9El9DS9mw9y9ZoKdsph+0F8zs+cSDLADMltZlPPUi5zmY9j11GvFRSrveMjw/fNQTs/qDCRX2dDsTVA4fBo8S3sbK9+H+xZwDU7SjRekAsBiVOFSeCR0rudoY2Tz7ersILdkIYGFFcJ70wiVD3VTZLm5iQpRnKNQSynMMKq2UITqekpRxDg72QPX+WVRQXmRZABFkd2d01aX57F9QyrDiJTP9lC0iDKHN9MPQ4QazOSfSCyniGIZWrnfhX/FZmIbOXVRZYluljGfimky1UteXm91c0QCoO+qB+TbVWQR39csmlImRCdW2nS80F1o37kJD1aag==
  template:
    metadata:
      name: wa-notif-postgres-admin
      namespace: apps
---
apiVersion: batch/v1
kind: Job
metadata:
  name: wa-notif-db-provision
  namespace: apps
spec:
  template:
    spec:
      containers:
        - name: psql
          image: bitnamilegacy/postgresql:17
          env:
            - name: PGHOST
              value: postgres.infra.svc.cluster.local
            - name: PGPORT
              value: "5432"
            - name: PGUSER
              value: postgres
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: wa-notif-postgres-admin
                  key: postgres-password
            - name: APP_DB
              valueFrom:
                secretKeyRef:
                  name: wa-notif-postgres-credentials
                  key: database
            - name: APP_USER
              valueFrom:
                secretKeyRef:
                  name: wa-notif-postgres-credentials
                  key: username
            - name: APP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: wa-notif-postgres-credentials
                  key: password
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail
              until pg_isready -h "$PGHOST" -p "$PGPORT" -U "$PGUSER"; do
                sleep 2
              done
              psql -v ON_ERROR_STOP=1 <<PSQL_EOF
              SELECT format('CREATE DATABASE %I;', '$APP_DB')
              WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname='$APP_DB')
              \gexec
              DO \$body\$
              BEGIN
                IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname='$APP_USER') THEN
                  EXECUTE format('CREATE USER %I WITH PASSWORD %L', '$APP_USER', '$APP_PASSWORD');
                ELSE
                  EXECUTE format('ALTER USER %I WITH PASSWORD %L', '$APP_USER', '$APP_PASSWORD');
                END IF;
              END
              \$body\$;
              SELECT format('ALTER DATABASE %I OWNER TO %I;', '$APP_DB', '$APP_USER')
              WHERE EXISTS (SELECT FROM pg_roles WHERE rolname='$APP_USER')
              \gexec
              PSQL_EOF
      restartPolicy: OnFailure
