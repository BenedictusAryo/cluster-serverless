---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: wa-notif-postgres-credentials
  namespace: apps
spec:
  encryptedData:
    # PLACEHOLDER - Replace with actual sealed secrets generated using kubeseal
    # Generate using: kubeseal --controller-namespace kube-system --controller-name sealed-secrets-controller --format yaml < secret.yaml
    database: REPLACE_WITH_SEALED_DATABASE_NAME
    password: REPLACE_WITH_SEALED_PASSWORD
    username: REPLACE_WITH_SEALED_USERNAME
    database-uri: REPLACE_WITH_SEALED_DATABASE_URI
  template:
    metadata:
      name: wa-notif-postgres-credentials
      namespace: apps
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: wa-notif-postgres-admin
  namespace: apps
spec:
  encryptedData:
    # NOTE: This encrypted value was copied from infra namespace and will not work
    # due to SealedSecrets namespace scoping. This needs to be regenerated with:
    # kubeseal --namespace apps --name wa-notif-postgres-admin --format yaml
    postgres-password: AgAfMWZeQMF9Vd3Lvc/ro7KhQlNJCcmFC/LigBSAlu7Si63O96bf5eCRX06Zpevv8E3DqGim3M7x658Ry4XZOiRht1/BX9WsZHLY+6hCSFWWiZFrvGznCch09BM7mkvtQ708/DCtZgN3hHJRcX2EzjbyqxQt0u+64yDjdp0bGdrFGY2+i5M79C2+RZpLjKGuR9+0Zfst4Vk+ZhWV79mD5+UBIwqaTzL7tOePow9k8jwMJC+QSdxe1SiI0FBwExIl8bnmNLwe0K011j3U6rKpr6xIvqMEKmxsPBwY/OwAOjFAk8iASV5KpU/nvxopg/GYcKK+VFx+LP1vFQaVLQc9EIobWvywMrQLlk25SqvDmQrirljAzB2qf+GJN22FN/w7TXCw90WnLRNZHBX+XH8H0GT27voYTehX/MuVnNsxAbIuX1zYsfyYYYQdYyHzxCfi/18+4RBjZDTIkmUxBMLJNdfzFEl6gQSoNe4TiBxlKJ/SIQmmE/r1gM4zA8dj81rss5iiKdsIh7FxFqlTxwHuxBwHQZ5EfVDMYFHHUDSUNsjkebPWOQvrJOAqqRK5rwn1pFy19NG4PhGMIt/nyOwLxmrLa5zeXVL1BO4Matm4zl5xlIHkx+1kL12pv7sjTabQSXOEiZTyaFd9mgQzH0HPiZAgAXreq0bJu06VeIlZ9g5wcQx6iIGKAUH9b+Y4bQPPvc6M+osYcB0XG1xFDQ==
  template:
    metadata:
      name: wa-notif-postgres-admin
      namespace: apps
---
apiVersion: batch/v1
kind: Job
metadata:
  name: wa-notif-db-provision
  namespace: apps
spec:
  template:
    spec:
      containers:
        - name: psql
          image: bitnamilegacy/postgresql:17
          env:
            - name: PGHOST
              value: postgres.infra.svc.cluster.local
            - name: PGPORT
              value: "5432"
            - name: PGUSER
              value: postgres
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: wa-notif-postgres-admin
                  key: postgres-password
            - name: APP_DB
              valueFrom:
                secretKeyRef:
                  name: wa-notif-postgres-credentials
                  key: database
            - name: APP_USER
              valueFrom:
                secretKeyRef:
                  name: wa-notif-postgres-credentials
                  key: username
            - name: APP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: wa-notif-postgres-credentials
                  key: password
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail
              until pg_isready -h "$PGHOST" -p "$PGPORT" -U "$PGUSER"; do
                sleep 2
              done
              psql -v ON_ERROR_STOP=1 <<PSQL_EOF
              SELECT format('CREATE DATABASE %I;', '$APP_DB')
              WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname='$APP_DB')
              \gexec
              DO \$body\$
              BEGIN
                IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname='$APP_USER') THEN
                  EXECUTE format('CREATE USER %I WITH PASSWORD %L', '$APP_USER', '$APP_PASSWORD');
                ELSE
                  EXECUTE format('ALTER USER %I WITH PASSWORD %L', '$APP_USER', '$APP_PASSWORD');
                END IF;
              END
              \$body\$;
              SELECT format('ALTER DATABASE %I OWNER TO %I;', '$APP_DB', '$APP_USER')
              WHERE EXISTS (SELECT FROM pg_roles WHERE rolname='$APP_USER')
              \gexec
              PSQL_EOF
      restartPolicy: OnFailure
