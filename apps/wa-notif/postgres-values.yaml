---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: wa-notif-postgres-credentials
  namespace: apps
spec:
  encryptedData:
    database: AgB3CNQmYHbQgZwK71vaFTorsJxRnwNp64yZ3APjDzWa4j2RSEB4e2zMQfmmQ0isvSEtHxC8MoTVnBZNSIDUSpfoS7L1Q8aFY46019T9cy/BdnEkVR4rNqSdNlKeKJFTvFgsb+oVB+iXqMWVBK9LL2nP9FpLPWA5OdXU4tq2S87n5UwaeCgkTkB/T3h+GmtsWOhkizie1DXZTJFMh3JdjDOclJtKfkg7GqXfSjQQF9qEdz293NwApRvC5XCKmeIncIQoItkm/PX8TdYk+0aSkREEUVcggVoBdv4gOveRWq4OtwoSFl6gE46z0l7ojjUBRs8n7RlNYIwaYvbHDabgTjNjUVsJ0ufU3kKAJqcfP23HJ7l1/PgZmFAYZzFuzhj/sOTvaz6t8ZWg7k//vEShMFoeuPar3tqKtfUhSkb/epoKHwArrgCT6OaZ0Pke38ElMIuklPJf2CaudpabCvH7gYcoJKe+8bHylvwUcc0trzKtqRSiR2F8bYW1ue3smEUYLwNAieJs37+7UI2e8omfKdPlbIOHOdmFj7CR12b1oZA9r92JVj9QIQu4s7v7Qn5PGWK+bLv6vnA8QhxUhkzwdWp47iTZUO+zHZX5tf3pz6P9HUo33O2Sgz0rLrzRnMoPx169PUSSN/h6nUdEvK5ele8cBy+DPXJEIHuyjhVT+EVP5348dtlJY0XXpSYMTcXFSnuBoiFFkk3TySQ=
    password: AgBZhMnmq1fJal1W8qRLWjAcFDDZ48Z5NpY2Oxo4TS2bWtiDRipRXWMz8liAKICpCMcMOsacryzP489eR+SC0kVKqe1cOO/BaHX4IEKfxSZr6wJ2VycnDrxu2IXZXUU7talZlijB6rMYSuhi9snxnAsFTX9By42CwXWdsbmpSuJQaU6STG3sy7s4xg7J1CriedKMKgdFJ+kZyE/E60RPFIvwbm4crQHKqCltZYuVboSbn4qAFkohPIFrC1kcm8mheWgrcTfdTq2WsJBALL+ya6VTfHW+NXV2Q7wZ81ly64nCTr0+X9CaRbjsLL1d5K41XleLGf0G2bM6aBFT4vAyd9e0+bsayWVAUfIjO91otigvTFNkn0mFYbH4BXCIu+ERiMarooEuz5EBd4sSXQ93GOzpvdAuo+ARnUzgrAYDhGIj3AoxOtlHDoIu2aq/GZQ339mlaCAsCJtiFOG3I8+AKdU/dGw68x7WzyeWpN6MGeR59MGzFfzypkWlcLEvIwfULdBb22YCVEvcYs9tGX6EoGkKhQawgoQ/Srw902/YNIR4NeqbG2Yjl/ijtJ5V3X44PAUPvP3okE51ujZmaCTzvLPjLJ2RkE9mKvgx862AZa3e5yNBWAZRU2/umo+dWh65GFuqg8SDEJQEIqQbNZKTDnRtyR9qflQUEchn/dWfo+kviBGtlirna3SbuWitwlt0pUmJz4MwQr1oD3Vivj40sPlxXyM=
    username: AgAU5Fo6WJW+XVDx8cSD1GDtnDTdK47uoJ+ItiEymWnXW7Nt6/XvimhjPzRjJS2CetYIwtPq4MlE+3ICDhSnh+pKyaCd7D2BeiyBdPmGSUsSio2HLG5OBgsICF1mUpfy4T+lHeAj3bW0av96KnNaLUBGW7jl1xtU32KsGq6JYfdTKRaryoPdqd/Arrbi1+wQYVz0H62gLIsAw8KVgoMhKa1ZUzZwfaJ+KoNyGiXW99X2kC67K/Azp5Hw5Jz0aW1dmfxKy4YpgfVdMHycSQoTqqeX3+08sF39og+MscFBRmJCwKJA+spYE7jrrRjbmSiwKu5rYTJoTPGpg9SmatQSpirrkXFjj65EgTl+wLO6tJkr30zm++dnkdkEv9DskVpnbjV7JFuxg8wFCnwvocfb99s62zxhKvFMbUHuwkALAv6Ow2y26htvBaNsKQR9UNAIG0yV2GO2yFscNgcKNUsI3ogW6qMM5U+fewN+jQwFe5JAbcZ9hDR0kohGGVIUvLiFurJLg+qFxkR8OaY/CACDECATa3AKH1XrqXmaWE2ThzZvpzkFsHLqWfmyU7pBoAcAdRpqbGQVKbDc9m8fb3xkbPnY37ZWXCAudHzNUMoDDLBjdMGn39FSlU7Ddq4hbfNLwew+aMPunYguHLfS7OW1VgTZLxbXOiGRkQc38zXO01vn34VGNyCf8m05lt/419VSGqSTiupl1NTbVfY=
    database-uri: AgCQkcroSUvVTol6CSIFjv+GM1n1f0/Q1NPrgOPGida2kswK4LPJQHUdV6yIZlgOsou+pEef0+AK7rvjTWusWy9uGk89YXA1Ns3t2H6kp5TREdB7LpMIbBG8bQsPDOjIUEMfMjcnC1ckb+R0wSJXCJhISwJEKuQLu/PcNhLjDGgTUqzBMXl1tSF90P5x3mRN2I0Pmog3PWrszEXKuO2YqoONIgVxlrBmTTtUuJJVHyj/nz0uryW7iWhlgpgTPey6INe9w74Jouj4n/k4Ys5EQGLM1D3liSsH3/vEwUWhBibyimRbaj7ay2RTyM+bMxJa/HmXjDca5n/3aY5oCmvC76akQy9jNAx1bRMAWIiZyozDnkJF4r3H0sSrv2aIPCWTr9yr771vnCtPoEa2pqqaDFF9PrQv7O+LLJSdtP3Q75zeLo64DEttr+EgPMD+7gRWa+NDaCm0xaugy6eUHeeq7Dt4EfIuStqFHjmC/48RQ2vir6+XgXB4pGMFngBMz2jNyoM9QuYQsXA5tDJnLN0VkwZK6S4ETDDD6ThsuKedsinLjAAzcxQntFUgaPna+5LPgmRcFzaMNunkaR7C0rjakEMzrbpXVnd22p1nieqXc5waN6WPlXSLwQQCyg59J2T+b+baGyHWjFx8Er8rkF+5RSSMEc6794aMEI+y+mk7Q0dDJku+d3mu7grieSqLabwemaCmfuw1dKMlQfmGQOm7tS5w4+yp1Jn4x1TOOSIVi//syU9Rm6B7U/8iemazO6HIu5XgpTFVhCLweRjqDAIptKtxSje+6ZVsXYJqsfLVru2M6ROlcli90yTlOnmV3lN9UTppkEA1
  template:
    metadata:
      name: wa-notif-postgres-credentials
      namespace: apps
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: wa-notif-postgres-admin
  namespace: apps
spec:
  encryptedData:
    postgres-password: AgCEnw3IUg/WEktNRgZFqna5FIFGfCBIU7AScHYzKLj1OHdfw50UyHH2OtSsP6tPedu3MS2c2bfkt7lsRULo5GSb4zdztnpR+GWbnnAJFVFw0QrdQtG9s7gN+lFLWUWhjzbz7FPxM6MqjjPirTtOsFAi/Y/WIv3DkfzL0bw1YdC9Rz2TN8YABQOI0iDKN42CEFCVvVsOg/Q4TCvN+J1z/7CfX/BDMJQxBqJoqkpo25faVD9yt6cydbFSYafwXgtunkpwRzuTkoEy52+dHZMiXZcy6B2K5D2M55I/oB+rU5cwuUVq67t7wOsvV0AQrY6kYWzSSyJp3rNreF/mqt2mKwzUlP40kMJzuSFfup0TLBL31f5hKswV54XuDktTH/wsu+/y1NaC5sLbQM96y6OtGChoQUT2fczHx1zTcs9ckX7/AROJsmORkJxRJB2PphdCw3oUk4/YCRgwV4VWv9qG8Jdi8PqsY+AW/n3BncteKlfdCSAQae0JdJu1fcpaHUOC6NGV4rWQoUZoUx/6hwfMa/ftuHJfxTWOxgWW/tlHlmdrzDBfqYMuQj319IvKKqars7kvsSRCR2NZpyOL/svIL0odct98vZTh12J9gxl0guM8iw7K6xeLiIzTTZwRMrib30gIvfKUhK1e3i97s4fO+u7686W5QOJw9TET9UN1XTCaxvRHfJQsP0mCmdkzGERo81KBvSMPC+Gk+IzWwg==
  template:
    metadata:
      name: wa-notif-postgres-admin
      namespace: apps
---
apiVersion: batch/v1
kind: Job
metadata:
  name: wa-notif-db-provision
  namespace: apps
spec:
  template:
    spec:
      containers:
        - name: psql
          image: bitnamilegacy/postgresql:17
          env:
            - name: PGHOST
              value: postgres.infra.svc.cluster.local
            - name: PGPORT
              value: "5432"
            - name: PGUSER
              value: postgres
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: wa-notif-postgres-admin
                  key: postgres-password
            - name: APP_DB
              valueFrom:
                secretKeyRef:
                  name: wa-notif-postgres-credentials
                  key: database
            - name: APP_USER
              valueFrom:
                secretKeyRef:
                  name: wa-notif-postgres-credentials
                  key: username
            - name: APP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: wa-notif-postgres-credentials
                  key: password
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail
              until pg_isready -h "$PGHOST" -p "$PGPORT" -U "$PGUSER"; do
                sleep 2
              done
              psql -v ON_ERROR_STOP=1 <<PSQL_EOF
              SELECT format('CREATE DATABASE %I;', '$APP_DB')
              WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname='$APP_DB')
              \gexec
              DO \$body\$
              BEGIN
                IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname='$APP_USER') THEN
                  EXECUTE format('CREATE USER %I WITH PASSWORD %L', '$APP_USER', '$APP_PASSWORD');
                ELSE
                  EXECUTE format('ALTER USER %I WITH PASSWORD %L', '$APP_USER', '$APP_PASSWORD');
                END IF;
              END
              \$body\$;
              SELECT format('ALTER DATABASE %I OWNER TO %I;', '$APP_DB', '$APP_USER')
              WHERE EXISTS (SELECT FROM pg_roles WHERE rolname='$APP_USER')
              \gexec
              PSQL_EOF
      restartPolicy: OnFailure
