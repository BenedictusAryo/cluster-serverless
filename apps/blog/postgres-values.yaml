---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: blog-postgres-credentials
  namespace: apps
spec:
  encryptedData:
    database: AgBRsq672YE8fwcTpQfezBtGVNfJXJiFQxMPzByfPyfX8V3O2VJMHl8C7JwS5ljjcOU9MXX1nNuiaBfUvl0WpaXHQUAyxtOn9CHlkgsbq/dYtmXgR4MvjMXpwKxR1RDlliDQNPeSQ4oLSrrJIh42NKLys9E1Ws1oymAcmu0F4QyqfJSGa5Db5qcIbMSzcz90c9KhLVV84m88i9+FXVBg8FduKztt8ihTLx+dTDo9FJcSWhMX7cdAQoUDABFNzICIGM1PmDsAY7GiU6ta8aUJ6qGsgbpwJ5WAnQGnHTq+Epm7hK8FS+xd7Aaspeg9S02ekd6nZ9Ewh8wSEptGybhtivNpfizuVHJHFKMHgvik7PptbRi7hFDEQ0/uNK8W6sQ7FjU01rnMbi8MwUsDIRyBKt1S9WGyaoqXiNyhr1Zl86NKM4mUGKClQ0rC+qOjoVhKUjBZsgGibndVEiH8gaCxO3WpDhB4TVZaCpUAiXI2qTLTNbIosW1csQA6qFZSpUe0MMkN4CAB3pFthstI3GpdOiW8ihQU35jESbjQNnTh99SF4WEssBc4Gc95fMH/AfIhAQEGpDf5scmfYdFBQ44vdfB0uG2uwZIp/gegywIBe56TChnNHCLkprQw2qk8x+ntgPjtROArJZe6VP45jpBwYvoRmUJYTxJSVJb2/pK4JotAeML+1WdACTTGubseZ/hj+ud6XNnW
    password: AgAeSSq+ShFWJ4ppWMqsoq4Q/Xgs4EcJQWo91SnE4uTPx5mpWC/QIWuDDz7n4LGONyYQrqM1RxKapWhkk0LgF/XBZOuN+MOn68DyV6YHqIa7E5RaZvMYlJdq4p7LxQAt0RdVoIgj3sTEm8eMGqCUQ6mj9acn8s5MopH81PmEGJ3Q4upcXHM1p4EJfthhEmQT4z20U5BeuqPIcaW1bCCvMLfn3wI0rZaahnH2ayLJpLDDQTwhml9yTLuRk15HbyERwp+n8jICaQZ07UmSmVEWiJ3VSxKbdtiW/MQGbTBXOXfvsc6VGr+4kqJ3XFxfxK1en9f2i/hokawhiSipPCzwyo1uRLFEB2+9LUH5CU+C6fdBXreHHd9LbYA/mzNcJ7XIct4iR7wzr74GYeo7dOBVA0IGNVHzxgmBLJ9Fj6Jv3ovXItQMkbh3evW51pz92cyDgQCaT4zeRUwg5AEbTAfxvscb10H7zIi17IUBAjqGS2dEJ8b5ppNHfObRDJqnCoU6toy83eFmTXApvtPViWeZ0m45AYzoSMMWdLUhGfZH+A5R/OKCoky7u8/JnwEeaQqAr7QNGFVzhwJm4LUK/jcf3NDKb0rF2YwjotZNtKZ6bsBvN+Bt8QwVbeI/RjPDi4GS4sZAMgzuqC4+AAoCpy4MpBbZtfVPBZySqJSHbyITSpa+ifmJAIJ+BqPIwLVLTsReRKjTF2sWQDdc3Eg=
    username: AgAIgBrAXisnKKZsEje7TigMLqSL0/RspU4bNA+kQMFZyGVsSk2Zs183g8vlmbuzVxTNK7/y9laTwgwer+lBFvKg1jRtIR7ir48YYfeToqEuqtAAMl/2pjnVXeTuwESYVP3Pitktrim1tdCRXuUuzZ/mFdmOBkHQAlad/+gupTf1ZglSQXP9FNgdcnvMcR50j+JVlXjHOfZmJguwC7FLiqO88p6eUMnA+hBsBxqdTMOiWM48prXeypycSXZ9BuIKrVSjtdfE1W6+8HiW4QYtsiy1HQdWVIBE1u+khMLxJBvr51iELrAf7fBPD9Xyaap6BPkRgYS4lR5CW3ytLHikbE5Rrke2bHtyBa1J7KcamNoljGdnaesLMNZcWERhAuWwFZ+hZ5j503zqPVQ5ZHk/7YJgMhadYrSuLURfdCgSs/YMmFOtpsXjmVsa4HSwVZkOnpdi95FVekMjfvg6n9xylpSsifJiRaHdkWyMQuycXYOOjjmU8ZnxkpxU9iJBqdIerN0PCRViTY5fsH0MXabwTZ1GNAWoLZNAB3xv3TtVcApoSl1mnJ7J6TlCcvGealZ4fXbWz4pcBX0ZnnTTjWNAilOHiMVIFE14dcxRrOrpf5SEVYFsrVeqortw0o72yGfc3AwaiI05o7IvboXMRwGs894xBD7IgkL0vi7bU6wkmckBT9UyfKREshc/JpoHYthCPn6IwH1ihMjgWM8=
  template:
    metadata:
      name: blog-postgres-credentials
      namespace: apps
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: blog-postgres-admin
  namespace: apps
spec:
  encryptedData:
    postgres-password: AgB5YUrJi0q4unQgDFe0siteXgsv6TBU02T6uQ7690ha3fkwDhXT9oKihVr+dEHN0hBz7hAamXorlyxu3Yyg/DenFpTMd90IJdg2eNs9BqHr1WyZMnChLnGw/Eq3wWuq/LXTmhMyCMjZ/5KTuKcy9YT5loBypgMsn2qT8nqlwmd0IYCHLvFFVkNnaQ9srXJOQV9+QXXpBy8anGf3TcKbMRstjsuxvaOh2SKPM7dxMwiQDR2qMH1yVeYK6vIgXCdnbAodAyAa4gzFOCooTitiyYPfv0mpdZnKOESNRUDfiv5hy8O5hy/PPFObzPjXAo4UL9Eg3DmnVUSYU0r8++W5H8aJEGgDa1snxYSj6t7UXuU5QU58uNBL8QxnGZ3K1117HWJnfObz2FWWRyHsNIhpYCEsP4vssgzUuF+xCy6cetns9SwtZCgTmq1BzfyBUdc13Rr6AvDSRnkGgECmorirFeMniLjYrzCxWIzrQF6QugncaPmQKr+XvuGfZulAfPcPiabnq6xmUL4nlQ4DDY4a+yDdFoBhJ1Ab/g62i5hOCh1rfhn4UvDGZUbzs2u/Lmg2jkCrrxmaEwrJhOtbxmqg5xpaXESLgI68kPTfjXfJARxBd2k1QXi2EB6K0Ba/12fsmINfnf+X45+3Nglkff/zDgbVMwpxirHHdExf4HuVMWsJ34rtcXtoThsgQWpDXza9QTzEmAA31CWqdmTCQg==
  template:
    metadata:
      name: blog-postgres-admin
      namespace: apps
---
apiVersion: batch/v1
kind: Job
metadata:
  name: blog-db-provision
  namespace: apps
spec:
  template:
    spec:
      containers:
        - name: psql
          image: bitnamilegacy/postgresql:17
          env:
            - name: PGHOST
              value: postgres.infra.svc.cluster.local
            - name: PGPORT
              value: "5432"
            - name: PGUSER
              value: postgres
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: blog-postgres-admin
                  key: postgres-password
            - name: APP_DB
              valueFrom:
                secretKeyRef:
                  name: blog-postgres-credentials
                  key: database
            - name: APP_USER
              valueFrom:
                secretKeyRef:
                  name: blog-postgres-credentials
                  key: username
            - name: APP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: blog-postgres-credentials
                  key: password
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail
              until pg_isready -h "$PGHOST" -p "$PGPORT" -U "$PGUSER"; do
                sleep 2
              done
              psql -v ON_ERROR_STOP=1 <<PSQL_EOF
              SELECT format('CREATE DATABASE %I;', '$APP_DB')
              WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname='$APP_DB')
              \gexec
              DO \$body\$
              BEGIN
                IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname='$APP_USER') THEN
                  EXECUTE format('CREATE USER %I WITH PASSWORD %L', '$APP_USER', '$APP_PASSWORD');
                ELSE
                  EXECUTE format('ALTER USER %I WITH PASSWORD %L', '$APP_USER', '$APP_PASSWORD');
                END IF;
              END
              \$body\$;
              SELECT format('ALTER DATABASE %I OWNER TO %I;', '$APP_DB', '$APP_USER')
              WHERE EXISTS (SELECT FROM pg_roles WHERE rolname='$APP_USER')
              \gexec
              PSQL_EOF
      restartPolicy: OnFailure
